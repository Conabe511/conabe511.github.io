<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Download Project Colored Mountains</title>

<script src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"></script>

<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Inter,Arial,sans-serif;margin:0;padding:24px;background:#0b0b0c;color:#e6e6e6}
  .card{max-width:520px;margin:0 auto;background:#17181a;border:1px solid #2a2c30;border-radius:12px;padding:20px;box-shadow:0 6px 18px rgba(0,0,0,0.4)}
  h1{margin:0 0 12px;font-size:20px}
  .row{display:flex;gap:12px;margin:10px 0}
  .row>div{flex:1}
  label{display:block;font-size:12px;margin-bottom:6px;color:#a9b0b8}
  select,button{width:100%;padding:10px;border-radius:8px;border:1px solid #3a3f45;background:#0f1012;color:#e6e6e6}
  button{cursor:pointer;background:#2e9bff;border-color:#2e9bff;font-weight:600}
  .status{min-height:20px;margin-top:10px;font-size:13px;color:#a9b0b8}
  .ok{color:#79ffa8}
  .err{color:#ff7d7d}
</style>
</head>
<body>
  <div class="card">
    <h1>Download Project Colored Mountains</h1>

    <button id="loginBtn">Sign in</button>
    <div id="userInfo" style="display:none;margin-bottom:10px;font-size:14px;color:#79ffa8"></div>

    <button id="downloadBtn" disabled>Get download link</button>
    <div class="status" id="status"></div>
  </div>

<script>
window.Clerk.load({
  publishableKey: "pk_test_aW1wcm92ZWQtdGVycmllci05LmNsZXJrLmFjY291bnRzLmRldiQ",
})
.then(async (clerk) => {
  const loginBtn = document.getElementById("loginBtn")
  const downloadBtn = document.getElementById("downloadBtn")
  const status = document.getElementById("status")
  const userInfo = document.getElementById("userInfo")

  function setStatus(t, cls=""){ status.className="status "+cls; status.textContent=t }

  async function updateAuthUI() {
    if (clerk.user) {
      loginBtn.textContent = "Sign out"
      userInfo.textContent = "Signed in as " + clerk.user.primaryEmailAddress.emailAddress
      userInfo.style.display = "block"
      downloadBtn.disabled = false
    } else {
      loginBtn.textContent = "Sign in"
      userInfo.style.display = "none"
      downloadBtn.disabled = true
    }
  }

  loginBtn.addEventListener("click", () => {
    if (clerk.user) clerk.signOut()
    else clerk.openSignIn()
  })

  async function download() {
    try {
      downloadBtn.disabled = true
      setStatus("Authenticating...")

      const token = await clerk.session.getToken()

      if (!token) throw new Error("Missing Clerk token")

      setStatus("Requesting signed URL...")


      const resp = await fetch("https://api.conabe.net/v1/pcm/sample", {
        headers: { "Authorization": "Bearer " + token }
      })

      if (!resp.ok) throw new Error("API error "+resp.status)

      const data = await resp.json()
      if (!data.signed_url) throw new Error("Invalid response")

      setStatus("Redirecting...", "ok")
      window.location.href = data.signed_url
    } catch (err) {
      setStatus("Failed: "+err.message, "err")
      downloadBtn.disabled = false
    }
  }

  downloadBtn.addEventListener("click", download)

  await clerk.addListener(updateAuthUI)
  updateAuthUI()
})
</script>

</body>
</html>
